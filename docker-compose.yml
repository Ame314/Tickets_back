services:

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    environment:
      SA_PASSWORD: "P@ssw0rd12345!"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./db:/db
      - ./backups:/var/opt/mssql/backup
    networks:
      - adb_net
    healthcheck:
      # Soluci칩n: Revisar los logs internos del SQL Server para la cadena de texto de "Recovery is complete",
      # lo cual es m치s confiable que depender de la herramienta sqlcmd.
      test: ["CMD-SHELL", "grep -q 'Recovery is complete' /var/opt/mssql/log/errorlog || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 45s # Se reduce, ya que sabemos que el inicio es r치pido.

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - adb_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  api:
    build: ./api
    container_name: api
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      JWT_SECRET: "change-this-secret-key-in-production"
      DATABASE_HOST: "sqlserver"
      DATABASE_PORT: "1433"
      DATABASE_USER: "sa"
      DATABASE_PASSWORD: "P@ssw0rd12345!"
      DATABASE_NAME: "soporte"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
    networks:
      - adb_net
    restart: unless-stopped

  batch:
    build: ./batch
    container_name: batch
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_HOST: "sqlserver"
      DATABASE_PORT: "1433"
      DATABASE_USER: "sa"
      DATABASE_PASSWORD: "P@ssw0rd12345!"
      DATABASE_NAME: "soporte"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
    networks:
      - adb_net
    restart: unless-stopped

  frontend:
    build:
      # Se usa la ruta real del proyecto frontend (`Tickets_ame`) en vez de `../frontend`
      # para evitar errores de contexto faltante en cualquier entorno.
      context: ../Tickets_ame
      dockerfile: Dockerfile
    container_name: frontend
    depends_on:
      - api
    ports:
      - "3000:3000"
    environment:
      # Nota: Si el frontend se ejecuta en tu m치quina local, localhost:8000 es correcto.
      # Si se ejecuta dentro de un contenedor en la misma red Docker, debe ser el nombre del servicio, p. ej., http://api:8000
      NEXT_PUBLIC_API_URL: "http://api:8000"
    networks:
      - adb_net
    restart: unless-stopped

  db-init:
    image: mcr.microsoft.com/mssql-tools
    container_name: db-init
    depends_on:
      sqlserver:
        condition: service_healthy
    volumes:
      - ./db:/db
    entrypoint: ["/bin/sh", "-c", "/opt/mssql-tools/bin/sqlcmd -S sqlserver -U sa -P \"P@ssw0rd12345!\" -i /db/init.sql"]
    networks:
      - adb_net
    restart: "no"

networks:
  adb_net:
    driver: bridge

volumes:
  sqlserver_data:
    driver: local
  redis_data:
    driver: local